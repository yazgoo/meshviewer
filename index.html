<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <LINK rel="stylesheet" href="meshviewer.css" type="text/css">
    <LINK rel="stylesheet" href="lib/jquery-ui/jquery-ui.min.css" type="text/css">
    <style type="text/css">

    </style>
</head>

<body>
<div id="leftMenu">
</div>

<div id="mainViewer">

    <script src="lib/jquery/jquery.min.js"></script>
    <script src="lib/jquery-ui/jquery-ui.min.js"></script>
    <script src="lib/threejs/three.min.js"></script>

    <script src="lib/threejs/loaders/BinaryLoader.js"></script>
    <script src="lib/threejs/loaders/MTLLoader.js"></script>
    <script src="lib/threejs/loaders/OBJMTLLoader.js"></script>

    <script src="lib/threejs/loaders/UTF8Loader.js"></script>

    <script src="lib/threejs/loaders/ctm/lzma.js"></script>
    <script src="lib/threejs/loaders/ctm/CTMLoader.js"></script>

    <script src="lib/threejs/Detector.js"></script>
    <script src="lib/threejs/TrackballControls.js"></script>
    <script src="lib/threejs/libs/stats.min.js"></script>

    <script id="objectView" src="meshviewer.js"></script>

    <div id="viewer"></div>
    <div id="progress"></div>
    <div id="timer"></div>
    <div id="weight"></div>

    <div id="buttons">
        <a id="download-button" href="javascript:download();">Download</a>
        <div id="face-buttons">
            <div class="buttons-header">VIEW</div>
            <div class="buttons-detail">
                <div id="face-buttons-table">
                    <div class="face-button" id="face-button-1"></div>
                    <div class="face-button" id="face-button-2" onclick="javascript:showTop()"></div>
                    <div class="face-button" id="face-button-3"></div>
                    <div class="clearfix"></div>
                    <div class="face-button" id="face-button-4" onclick="javascript:showLeft()"></div>
                    <div class="face-button" id="face-button-5" onclick="javascript:showFront()"></div>
                    <div class="face-button" id="face-button-6" onclick="javascript:showRight()"></div>
                    <div class="clearfix"></div>
                    <div class="face-button" id="face-button-7"></div>
                    <div class="face-button" id="face-button-8" onclick="javascript:showBottom()"></div>
                    <div class="face-button" id="face-button-9" onclick="javascript:showBack()"></div>
                    <div class="clearfix"></div>
                </div>
            </div>
        </div>
        <div id="advanced-buttons">
            <div class="buttons-header">ADVANCED</div>
            <div class="buttons-detail">
                <p>ROTATE</p>
                <div id="rotate-buttons">
                    <div id="sphere-button-1" class="sphere-button" onclick="javascript:rotateLeft()"></div>
                    <div id="sphere-button-2" class="sphere-button" onclick="javascript:rotateRight()"></div>
                    <div class="clearfix"></div>
                </div>
                <div id="pan-buttons">
                    <p>PAN</p>
                        <img src="assets/icons/24/square_empty_icon&24.png" /><img src="assets/icons/24/sq_br_up_icon&24.png" onclick="javascript:translateUp()"/><br/>
                        <img src="assets/icons/24/sq_br_prev_icon&24.png" onclick="javascript:translateLeft()"/><img src="assets/icons/24/square_shape_icon&24.png" onclick="javascript:translateReset()"/><img src="assets/icons/24/sq_br_next_icon&24.png" onclick="javascript:translateRight()"/><br/>
                        <img src="assets/icons/24/square_empty_icon&24.png" /><img src="assets/icons/24/sq_br_down_icon&24.png" onclick="javascript:translateDown()"/><br/>
                </div>
                <div id="zoom-buttons">
                    <P>ZOOM</P>
                        <img src="assets/icons/24/sq_minus_icon&24.png" onclick="javascript:zoomOut()"/>
                        <img src="assets/icons/24/sq_plus_icon&24.png" onclick="javascript:zoomIn()" /><br/>
                </div>
                <div id="advanced-toggler-buttons">
                    <P>TOGGLERS</P>
                    <a href="javascript:scene.add(axes);">AXIS ON</a>
                    <a href="javascript:scene.remove(axes);">AXIS OFF</a><br/>
                    <a href="javascript:scene.add(boundingbox);">BBOX ON</a>
                    <a href="javascript:scene.remove(boundingbox);">BBOX OFF</a><br/>
                    <a href="javascript:addPlinth();">PLINTH ON</a>
                    <a href="javascript:removePlinth();">PLINTH OFF</a><br/>
                    <a href="javascript:rotateOn();">ROTATE ON</a>
                    <a href="javascript:rotateOff();">ROTATE OFF</a>
                </div>
            </div>
        </div>
    </div>

    <script src="lib/zip/zip.js"></script>
    <script src="lib/zip/deflate.js"></script>
    <script src="lib/zip/zip-ext.js"></script>
    <script>
function load_mesh(name)
{
    window.current_mesh = {
            'meshFile' : 'examples/mt7/' + name + '.obj',
            'mtlFile' : 'examples/mt7/' + name + '.mtl',
            'container': '#viewer',
            'directory': 'examples/mt7/',
            'name': name,
            'format':'obj'}
    parse_texture_files(window.current_mesh);
    meshviewer(window.current_mesh)
    window.location.hash = '#' + name 
}
function download()
{
    var mesh = window.current_mesh;
    console.log(window.current_mesh);
    window.current_mesh["i"] = 0
    zip.useWebWorkers = false;
    // window.saveAs
    // Shims the saveAs method, using saveBlob in IE10.
    // And for when Chrome and FireFox get round to implementing saveAs we have their vendor prefixes ready.
    // But otherwise this creates a object URL resource and opens it on an anchor tag which contains the "download" attribute (Chrome)
    // ... or opens it in a new tab (FireFox)
    // @author Andrew Dodson
    // @copyright MIT, BSD. Free to clone, modify and distribute for commercial and personal use.
     
    window.saveAs || ( window.saveAs = (window.navigator.msSaveBlob ? function(b,n){ return window.navigator.msSaveBlob(b,n); } : false) || window.webkitSaveAs || window.mozSaveAs || window.msSaveAs || (function(){
                 
                // URL's
                window.URL || (window.URL = window.webkitURL);
                 
                if(!window.URL){
                return false;
                }
                 
                return function(blob,name){
                var url = URL.createObjectURL(blob);
                 
                // Test for download link support
                if( "download" in document.createElement('a') ){
                 
                var a = document.createElement('a');
                a.setAttribute('href', url);
                a.setAttribute('download', name);
                 
                // Create Click event
                var clickEvent = document.createEvent ("MouseEvent");
                clickEvent.initMouseEvent ("click", true, true, window, 0,
                        clickEvent.screenX, clickEvent.screenY, clickEvent.clientX, clickEvent.clientY,
                        clickEvent.ctrlKey, clickEvent.altKey, clickEvent.shiftKey, clickEvent.metaKey,
                        0, null);
                 
                // dispatch click event to simulate download
                a.dispatchEvent (clickEvent);
                 
                }
                else{
                    // fallover, open resource in new tab.
                    window.open(url, '_blank', '');
                }
                };
                 
    })() );
    zip.createWriter(new zip.BlobWriter(), function(writer) {
writer.add_next_texture = function()
{
    if(mesh.i < mesh.textures.length)
    {
        var texture = mesh.textures[mesh.i];
        mesh.i += 1
        writer.add(mesh.name + "/" + texture, new zip.HttpReader(mesh.directory + texture), function() {
            writer.add_next_texture();
            });
    }
    else
    {
        writer.close(function(blob) {
                window.saveAs(blob, window.current_mesh.name + ".zip");
                    });
    }
}

            // use a TextReader to read the String to add
            writer.add(mesh.name + "/" + mesh.name + ".obj", new zip.HttpReader(window.current_mesh.meshFile), function() {
                writer.add(mesh.name + "/" + mesh.name + ".mtl", new zip.HttpReader(window.current_mesh.mtlFile), function() {
                    writer.add_next_texture();
                
                }, function(currentIndex, totalIndex) {
                });
            }, function(error) {
                });
            });
}
    $.getJSON("examples/mt7/list.json", function(data) {
            str = ""
            for(i in data)
            {
                    str += "<a href=\"javascript:load_mesh('" + data[i] + "')\""
                    //str += "onmouseover='$(\"#preview\").src=\"examples/mt7/"+data[i]+".png\"'"
                    str += ">"
                    str += data[i].replace(/,/g, "/") + "</a><br/>"
            }
            $("#leftMenu").html(str)

    }).error(function(a, b, error)
    {
    console.log(error)
    })
function parse_texture_files(mesh)
{
    console.log(mesh.mtlFile);
    mesh["textures"] = []
    $.get(mesh.mtlFile,function(txt){
            var lines = txt.split("\n");
            for (var i = 0, len = lines.length; i < len; i++) {
            if(/png$/.test(lines[i]))
            {
                var texture = lines[i].split(" ");
                var png = texture[texture.length - 1]
                if($.inArray(png, mesh.textures) == -1)
                    mesh.textures.push(png);
            }
            }
            console.log(mesh);
            }
         , "text")
}
var hash = window.location.hash.substring(1);
load_mesh(hash);

    </script>
</body>
</html>
